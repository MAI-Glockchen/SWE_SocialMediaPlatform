FROM python:3.11-slim

WORKDIR /app

# System deps
RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

# Python deps
RUN pip install --no-cache-dir --upgrade pip

RUN pip install --no-cache-dir \
    torch==2.2.2+cpu \
    --index-url https://download.pytorch.org/whl/cpu

RUN pip install --no-cache-dir \
    "numpy<2" \
    requests \
    pika \
    "transformers>=4.57.3,<5.0.0" \
    huggingface_hub

# ---- PRE-DOWNLOAD MODEL (NO HEREDOC) ----
RUN python -c "from huggingface_hub import snapshot_download; \
snapshot_download(repo_id='gpt2', local_dir='/hf_models/bloomz-560m', local_dir_use_symlinks=False); \
print('Bloomz-560m downloaded')"

# Cache env
ENV HF_HOME=/hf_models
ENV TRANSFORMERS_CACHE=/hf_models

# App code
COPY . .

CMD ["python", "main.py"]
